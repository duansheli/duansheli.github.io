<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.59.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>使用jstack分析线程-示例 | 断舍离的博客</title>
    <meta property="og:title" content="使用jstack分析线程-示例 - 断舍离的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2019-06-10T17:28:13&#43;08:00">
        
        
    <meta property="article:modified_time" content="2019-06-10T17:28:13&#43;08:00">
        
    <meta name="Keywords" content="java,scala,spark,kubernetes">
    <meta name="description" content="使用jstack分析线程-示例">
        
    <meta name="author" content="断舍离">
    <meta property="og:url" content="/duansheli.github.io/2019/02/10/jstack-demo.html">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/duansheli.github.io/css/normalize.css">
    
        <link rel="stylesheet" href="/duansheli.github.io/css/prism.css">
    
    <link rel="stylesheet" href="/duansheli.github.io/css/style.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="/duansheli.github.io">
                        断舍离的博客
                    </a>
                
                <p class="description">java, scala, spark, kubernetes</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="/duansheli.github.io">首页</a>
                    
                    <a  href="/duansheli.github.io/archives/" title="归档">归档</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
        
        <div id="virtual_toc_list" style="display: none">
            <nav id="TableOfContents">
<ul>
<li><a href="#1-使用jstack分析线程-示例">1. 使用jstack分析线程-示例</a>
<ul>
<li><a href="#1-1-死锁">1.1. 死锁</a>
<ul>
<li><a href="#1-1-1-死锁示例代码">1.1.1. 死锁示例代码</a></li>
<li><a href="#1-1-2-查找死锁">1.1.2. 查找死锁</a></li>
</ul></li>
<li><a href="#1-2-死循环">1.2. 死循环</a>
<ul>
<li><a href="#1-2-1-死循环示例代码">1.2.1. 死循环示例代码</a></li>
<li><a href="#1-2-2-追踪占用cpu的代码">1.2.2. 追踪占用cpu的代码</a></li>
</ul></li>
<li><a href="#1-3-思考">1.3. 思考</a></li>
</ul></li>
</ul>
</nav>
        </div>
        <div id="float_toc_div" style="margin: 10px;border: 1px solid gray;z-index:99999;display: none;">
            <header style="background-color: #f3f3f3;color: black;border-bottom: 1px solid gray;padding: 10px 10px 10px 10px;">
                <strong id="toc_btn_open" style="color: black;font-size: large;">目录</strong>
                <strong id="toc_btn_close" style="color: black;font-size: large;float: right">╳</strong>
            </header>
            <div id="toc_list" style="background-color: #f3f3f3;color: black;padding: 10px;">
        
            </div>
        </div>
        <style type="text/css">
            #float_toc_div {
                position: fixed;
                display: none;
                 
                height: auto;
                font-size: 13px;
            }
        
            #toc_list a:hover,
            #toc_list a:active {
                color: #ba3925;
            }
        </style>
        <script>
            window.onload = function () {
                let tocNavElem = document.getElementById("TableOfContents");
                let floatTocDivElem = document.getElementById("float_toc_div");
                let tocListElem = floatTocDivElem.getElementsByTagName('div')[0];
                let colGroupElem = document.getElementById("body").getElementsByClassName("col-group")[0]
                let floatTocWidth = (document.body.clientWidth - colGroupElem.offsetWidth) / 2 - 16;
                var useFloatToc = false;

                if (floatTocWidth >= 100) {
                    useFloatToc = true;
                    document.getElementById("toc_list").appendChild(tocNavElem);
                    floatTocDivElem.style.display = 'block';
                    floatTocDivElem.style.width = floatTocWidth + 'px';
                    top();
                    floatTocDivElem.style.left = '0px';

                    function top() {
                        if (document.getElementsByClassName('container')[0].offsetWidth <= 720) {
                            floatTocDivElem.style.top = '0px';
                        } else {
                            floatTocDivElem.style.top = window.innerHeight / 9 + 'px';
                        }
                    }

                    function ishide() {
                        if (document.getElementsByClassName('container')[0].offsetWidth <= 720) {
                            floatTocDivElem.style.top = '0px';
                        } else {
                            floatTocDivElem.style.display = 'block';
                        }
                    }

                    window.onscroll = function () {
                        ishide();
                        if ((document.documentElement.scrollTop != 0) && (floatTocDivElem.style.display == 'block')) {
                            top();
                        }
                    };

                    window.onresize = function () {
                        ishide();
                    }

                    document.getElementById("toc_btn_open").addEventListener('click', function () {
                        switch (tocListElem.style.display) {
                            case "none":
                                document.getElementById("toc_btn_close").style.display = "";
                                tocListElem.style.display = "";
                                floatTocDivElem.getElementsByTagName("header")[0].style.borderBottom = "1px solid gray";
                                break;
                            default:
                                break;
                        }
                    }, false);

                    document.getElementById("toc_btn_close").addEventListener('click', function () {
                        switch (tocListElem.style.display) {
                            case "":
                                document.getElementById("toc_btn_close").style.display = "none";
                                tocListElem.style.display = "none";
                                floatTocDivElem.getElementsByTagName("header")[0].style.borderBottom = "";
                                break;
                            default:
                                break;
                        }
                    }, false);
                } else {
                    let fixedTocElem = document.getElementsByClassName("toc-article")[0];
                    fixedTocElem.appendChild(tocNavElem);
                    fixedTocElem.parentElement.style.display = "";
                }
                document.getElementById("virtual_toc_list").remove();
            };   
        </script>
        
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">使用jstack分析线程-示例</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2019年6月10日
                        </date>
                        
                        
                        
                        <div class="clear" style="display: none">
                            <div class="toc-article">
                                <div class="toc-title">文章目录</div>
                            </div>
                        </div>
                        
                        <div class="post-content">
                            

<h1 id="1-使用jstack分析线程-示例">1. 使用jstack分析线程-示例</h1>

<p>通过两个demo来学习如何使用jstack</p>

<h2 id="1-1-死锁">1.1. 死锁</h2>

<h3 id="1-1-1-死锁示例代码">1.1.1. 死锁示例代码</h3>

<pre><code class="language-java">import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.LockSupport;
import java.util.concurrent.locks.ReentrantLock;

class DeadLockDemo {

    public static void main(String[] args) throws Exception {
        dead1();
        dead2();
        System.out.println(&quot;main-done&quot;);
    }

    public static void dead1() {
        String a = &quot;a&quot;;
        String b = &quot;b&quot;;
        new Thread(() -&gt; {
            String name = &quot;线程1&quot;;
            synchronized (a) {
                LockSupport.parkNanos(TimeUnit.SECONDS.toNanos(2));
                System.out.println(name + &quot; - lock - a&quot;);
                synchronized (b) {
                    System.out.println(name + &quot; - lock - b&quot;);
                }
            }
        }).start();
        new Thread(() -&gt; {
            String name = &quot;线程2&quot;;
            synchronized (b) {
                LockSupport.parkNanos(TimeUnit.SECONDS.toNanos(2));
                System.out.println(name + &quot; - lock - a&quot;);
                synchronized (a) {
                    System.out.println(name + &quot; - lock - b&quot;);
                }
            }
        }).start();
    }

    public static void dead2() {
        ReentrantLock a = new ReentrantLock();
        ReentrantLock b = new ReentrantLock();
        new Thread(() -&gt; {
            String name = &quot;线程3&quot;;
            a.lock();
            {
                LockSupport.parkNanos(TimeUnit.SECONDS.toNanos(2));
                System.out.println(name + &quot; - lock - a&quot;);

                b.lock();
                System.out.println(name + &quot; - lock - b&quot;);
                b.unlock();
            }
            a.unlock();
        }).start();
        new Thread(() -&gt; {
            String name = &quot;线程4&quot;;
            b.lock();
            {
                LockSupport.parkNanos(TimeUnit.SECONDS.toNanos(2));
                System.out.println(name + &quot; - lock - a&quot;);

                a.lock();
                System.out.println(name + &quot; - lock - b&quot;);
                a.unlock();
            }
            b.unlock();
        }).start();
    }

}
</code></pre>

<h3 id="1-1-2-查找死锁">1.1.2. 查找死锁</h3>

<pre><code>D:\&gt;jps
183716 Jps
168072
182296 RemoteMavenServer
178780 Launcher
183740 DeadLockDemo
D:\&gt;jstack 183740 &gt; dead-info.txt
</code></pre>

<p>运行死锁代码后， 通过jps得到 DeadLockDemo 的 pid为 183740<br />
然后将 jstack 183740 信息打印到 dead-info.txt 中</p>

<pre><code>2019-06-19 12:48:17
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.201-b09 mixed mode):

&quot;DestroyJavaVM&quot; #15 prio=5 os_prio=0 tid=0x0000000003463800 nid=0x2cab0 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Thread-3&quot; #14 prio=5 os_prio=0 tid=0x0000000022db3800 nid=0x2c028 waiting on condition [0x00000000241ce000]
   java.lang.Thread.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &lt;0x0000000740e9fde0&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
        at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
        at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
        at demo.DeadLockDemo.lambda$dead2$3(Test01_cache.java:64)
        at demo.DeadLockDemo$$Lambda$4/1329552164.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

&quot;Thread-2&quot; #13 prio=5 os_prio=0 tid=0x0000000022db2800 nid=0x2ba04 waiting on condition [0x00000000240cf000]
   java.lang.Thread.State: WAITING (parking)
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &lt;0x0000000740e9fe10&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
        at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
        at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
        at demo.DeadLockDemo.lambda$dead2$2(Test01_cache.java:51)
        at demo.DeadLockDemo$$Lambda$3/668386784.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

&quot;Thread-1&quot; #12 prio=5 os_prio=0 tid=0x0000000022dae000 nid=0x2b224 waiting for monitor entry [0x0000000023fce000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at demo.DeadLockDemo.lambda$dead1$1(Test01_cache.java:35)
        - waiting to lock &lt;0x00000007408ec448&gt; (a java.lang.String)
        - locked &lt;0x00000007408ec478&gt; (a java.lang.String)
        at demo.DeadLockDemo$$Lambda$2/1607521710.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

&quot;Thread-0&quot; #11 prio=5 os_prio=0 tid=0x00000000235d6800 nid=0x2c874 waiting for monitor entry [0x0000000023ecf000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at demo.DeadLockDemo.lambda$dead1$0(Test01_cache.java:25)
        - waiting to lock &lt;0x00000007408ec478&gt; (a java.lang.String)
        - locked &lt;0x00000007408ec448&gt; (a java.lang.String)
        at demo.DeadLockDemo$$Lambda$1/1452126962.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

&quot;Service Thread&quot; #10 daemon prio=9 os_prio=0 tid=0x0000000022ae2800 nid=0x2b484 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C1 CompilerThread2&quot; #9 daemon prio=9 os_prio=2 tid=0x0000000022a68800 nid=0x2cde0 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C2 CompilerThread1&quot; #8 daemon prio=9 os_prio=2 tid=0x0000000022a81000 nid=0x2cd54 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C2 CompilerThread0&quot; #7 daemon prio=9 os_prio=2 tid=0x0000000022a67800 nid=0x2afc8 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Monitor Ctrl-Break&quot; #6 daemon prio=5 os_prio=0 tid=0x0000000022a5c800 nid=0x1ab0c runnable [0x00000000230ce000]
   java.lang.Thread.State: RUNNABLE
        at java.net.SocketInputStream.socketRead0(Native Method)
        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)
        at java.net.SocketInputStream.read(SocketInputStream.java:171)
        at java.net.SocketInputStream.read(SocketInputStream.java:141)
        at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
        at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
        at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
        - locked &lt;0x00000007409abd98&gt; (a java.io.InputStreamReader)
        at java.io.InputStreamReader.read(InputStreamReader.java:184)
        at java.io.BufferedReader.fill(BufferedReader.java:161)
        at java.io.BufferedReader.readLine(BufferedReader.java:324)
        - locked &lt;0x00000007409abd98&gt; (a java.io.InputStreamReader)
        at java.io.BufferedReader.readLine(BufferedReader.java:389)
        at com.intellij.rt.execution.application.AppMainV2$1.run(AppMainV2.java:64)

&quot;Attach Listener&quot; #5 daemon prio=5 os_prio=2 tid=0x000000002166a000 nid=0x24148 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=2 tid=0x0000000021620000 nid=0x2c244 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Finalizer&quot; #3 daemon prio=8 os_prio=1 tid=0x000000000355c000 nid=0x2cec4 in Object.wait() [0x000000002296f000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        - waiting on &lt;0x0000000740788ed0&gt; (a java.lang.ref.ReferenceQueue$Lock)
        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
        - locked &lt;0x0000000740788ed0&gt; (a java.lang.ref.ReferenceQueue$Lock)
        at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
        at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)

&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=2 tid=0x0000000003553000 nid=0x1cd0c in Object.wait() [0x000000002286f000]
   java.lang.Thread.State: WAITING (on object monitor)
        at java.lang.Object.wait(Native Method)
        - waiting on &lt;0x0000000740786bf8&gt; (a java.lang.ref.Reference$Lock)
        at java.lang.Object.wait(Object.java:502)
        at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
        - locked &lt;0x0000000740786bf8&gt; (a java.lang.ref.Reference$Lock)
        at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)

&quot;VM Thread&quot; os_prio=2 tid=0x00000000215d7800 nid=0x2c4cc runnable

&quot;GC task thread#0 (ParallelGC)&quot; os_prio=0 tid=0x0000000003479000 nid=0x2c2b4 runnable

&quot;GC task thread#1 (ParallelGC)&quot; os_prio=0 tid=0x000000000347a800 nid=0x2bcac runnable

&quot;GC task thread#2 (ParallelGC)&quot; os_prio=0 tid=0x000000000347c000 nid=0x29578 runnable

&quot;GC task thread#3 (ParallelGC)&quot; os_prio=0 tid=0x000000000347e800 nid=0x1ca24 runnable

&quot;VM Periodic Task Thread&quot; os_prio=2 tid=0x0000000022b3a000 nid=0x2a978 waiting on condition

JNI global references: 320


Found one Java-level deadlock:
=============================
&quot;Thread-3&quot;:
  waiting for ownable synchronizer 0x0000000740e9fde0, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by &quot;Thread-2&quot;
&quot;Thread-2&quot;:
  waiting for ownable synchronizer 0x0000000740e9fe10, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by &quot;Thread-3&quot;

Java stack information for the threads listed above:
===================================================
&quot;Thread-3&quot;:
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &lt;0x0000000740e9fde0&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
        at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
        at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
        at demo.DeadLockDemo.lambda$dead2$3(Test01_cache.java:64)
        at demo.DeadLockDemo$$Lambda$4/1329552164.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
&quot;Thread-2&quot;:
        at sun.misc.Unsafe.park(Native Method)
        - parking to wait for  &lt;0x0000000740e9fe10&gt; (a java.util.concurrent.locks.ReentrantLock$NonfairSync)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:870)
        at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1199)
        at java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:209)
        at java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:285)
        at demo.DeadLockDemo.lambda$dead2$2(Test01_cache.java:51)
        at demo.DeadLockDemo$$Lambda$3/668386784.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found one Java-level deadlock:
=============================
&quot;Thread-1&quot;:
  waiting to lock monitor 0x0000000003558ed8 (object 0x00000007408ec448, a java.lang.String),
  which is held by &quot;Thread-0&quot;
&quot;Thread-0&quot;:
  waiting to lock monitor 0x000000000355b6b8 (object 0x00000007408ec478, a java.lang.String),
  which is held by &quot;Thread-1&quot;

Java stack information for the threads listed above:
===================================================
&quot;Thread-1&quot;:
        at demo.DeadLockDemo.lambda$dead1$1(Test01_cache.java:35)
        - waiting to lock &lt;0x00000007408ec448&gt; (a java.lang.String)
        - locked &lt;0x00000007408ec478&gt; (a java.lang.String)
        at demo.DeadLockDemo$$Lambda$2/1607521710.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
&quot;Thread-0&quot;:
        at demo.DeadLockDemo.lambda$dead1$0(Test01_cache.java:25)
        - waiting to lock &lt;0x00000007408ec478&gt; (a java.lang.String)
        - locked &lt;0x00000007408ec448&gt; (a java.lang.String)
        at demo.DeadLockDemo$$Lambda$1/1452126962.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 2 deadlocks.
</code></pre>

<p>在线程信息的尾部: <code>Found one Java-level deadlock:</code> 和 <code>Found 2 deadlocks.</code>
工具已经帮我们分析出了死锁的线程。</p>

<h2 id="1-2-死循环">1.2. 死循环</h2>

<p>有时线程的代码逻辑有问题会导致cpu占用率很高。</p>

<h3 id="1-2-1-死循环示例代码">1.2.1. 死循环示例代码</h3>

<pre><code class="language-java">cat &gt; LoopDemo.java &lt;&lt;EOF
class LoopDemo {
    public static void main(String[] args) throws Exception {
        new Thread(() -&gt; {
            int x = 1, y = x;
            while (true) {
                y = x + 1;
                x = y - 1;
            }
        }).start();
        System.out.println(&quot;main-done&quot;);
    }
}
EOF
</code></pre>

<p>直接写个死循环</p>

<pre><code class="language-bash">root@b3c8cc4ef0ae:/usr/games# javac LoopDemo.java 
root@b3c8cc4ef0ae:/usr/games# java LoopDemo &amp;
</code></pre>

<p>运行死循环代码</p>

<h3 id="1-2-2-追踪占用cpu的代码">1.2.2. 追踪占用cpu的代码</h3>

<pre><code class="language-bash">root@b3c8cc4ef0ae:/usr/games# top
top - 07:40:58 up 24 min,  0 users,  load average: 0.77, 0.63, 0.45
Tasks:   3 total,   1 running,   2 sleeping,   0 stopped,   0 zombie
%Cpu(s): 18.4 us,  1.1 sy,  0.0 ni, 79.0 id,  1.3 wa,  0.0 hi,  0.0 si,  0.1 st
KiB Mem :  2040828 total,   722372 free,   455908 used,   862548 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  1423680 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND    
  190 root      20   0 2697428  27740  15524 S 106.7  1.4   0:55.63 java       
    1 root      20   0   20180   4060   3592 S   0.0  0.2   0:00.57 bash       
  218 root      20   0   38288   3480   3052 R   0.0  0.2   0:00.00 top        


root@b3c8cc4ef0ae:/usr/games# jps
219 Jps
190 LoopDemo
</code></pre>

<p>运行top 可发现 pid=190 的程序占用cpu严重</p>

<pre><code class="language-bash">root@b3c8cc4ef0ae:/usr/games# top -p 190 -H
top - 07:42:05 up 25 min,  0 users,  load average: 0.92, 0.70, 0.49
Threads:  13 total,   1 running,  12 sleeping,   0 stopped,   0 zombie
%Cpu(s): 50.4 us,  0.0 sy,  0.0 ni, 49.6 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  2040828 total,   722332 free,   455836 used,   862660 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  1423720 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND    
  202 root      20   0 2697428  27740  15524 R 99.9  1.4   2:02.57 java       
  190 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  191 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.27 java       
  192 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  193 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  194 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  195 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  196 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  197 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  198 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.03 java       
  199 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.09 java       
  200 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.00 java       
  201 root      20   0 2697428  27740  15524 S  0.0  1.4   0:00.11 java       

###或者 ps -mp 190 -o THREAD,tid,time | sort -rn 
###或者 top -bn1 -H -p 190

root@b3c8cc4ef0ae:/usr/games# printf &quot;%x \n&quot; 202
ca 
</code></pre>

<p>针对 pid=190 的程序 ， 使用top 查看其线程状态<br />
发现 pid=202 的线程在占用cpu， 把202换算为16进制为 ca</p>

<pre><code class="language-bash">root@b3c8cc4ef0ae:/usr/games# jstack 190 &gt; deadloop.txt
root@b3c8cc4ef0ae:/usr/games# cat deadloop.txt 
2019-06-19 07:49:57
Full thread dump OpenJDK 64-Bit Server VM (25.212-b04 mixed mode):

&quot;Attach Listener&quot; #10 daemon prio=9 os_prio=0 tid=0x00007f79a0001000 nid=0xf5 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;DestroyJavaVM&quot; #9 prio=5 os_prio=0 tid=0x00007f79d800b000 nid=0xbf waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Thread-0&quot; #8 prio=5 os_prio=0 tid=0x00007f79d818f000 nid=0xca runnable [0x00007f79c6163000]
   java.lang.Thread.State: RUNNABLE
	at LoopDemo.lambda$main$0(LoopDemo.java:7)
	at LoopDemo$$Lambda$1/471910020.run(Unknown Source)
	at java.lang.Thread.run(Thread.java:748)

&quot;Service Thread&quot; #7 daemon prio=9 os_prio=0 tid=0x00007f79d80c2800 nid=0xc8 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C1 CompilerThread1&quot; #6 daemon prio=9 os_prio=0 tid=0x00007f79d80b7800 nid=0xc7 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;C2 CompilerThread0&quot; #5 daemon prio=9 os_prio=0 tid=0x00007f79d80b4800 nid=0xc6 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Signal Dispatcher&quot; #4 daemon prio=9 os_prio=0 tid=0x00007f79d80b3000 nid=0xc5 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

&quot;Finalizer&quot; #3 daemon prio=8 os_prio=0 tid=0x00007f79d8080800 nid=0xc4 in Object.wait() [0x00007f79c6904000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on &lt;0x00000000f5988ed0&gt; (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
	- locked &lt;0x00000000f5988ed0&gt; (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)

&quot;Reference Handler&quot; #2 daemon prio=10 os_prio=0 tid=0x00007f79d807e000 nid=0xc3 in Object.wait() [0x00007f79c6a05000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on &lt;0x00000000f5986bf8&gt; (a java.lang.ref.Reference$Lock)
	at java.lang.Object.wait(Object.java:502)
	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
	- locked &lt;0x00000000f5986bf8&gt; (a java.lang.ref.Reference$Lock)
	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)

&quot;VM Thread&quot; os_prio=0 tid=0x00007f79d8074800 nid=0xc2 runnable 

&quot;GC task thread#0 (ParallelGC)&quot; os_prio=0 tid=0x00007f79d8020800 nid=0xc0 runnable 

&quot;GC task thread#1 (ParallelGC)&quot; os_prio=0 tid=0x00007f79d8022800 nid=0xc1 runnable 

&quot;VM Periodic Task Thread&quot; os_prio=0 tid=0x00007f79d80c5000 nid=0xc9 waiting on condition 

JNI global references: 309
</code></pre>

<p>通过jstack命令查看程序的线程信息<br />
可以找到  nid=0xca   的线程 &ldquo;Thread-0&rdquo;</p>

<h2 id="1-3-思考">1.3. 思考</h2>

<p>如果说代码比较复杂， 死锁jstack不一定能找到。<br />
可以优先关注线程状态为 BLOCKED 或 WAITING 的线程，看线程的阻塞是否合理。</p>

<p>除了死循环可能导致cpu飙高， 也可能是多线程自旋锁之间频繁的竞争。</p>

                        </div>

                        


                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/duansheli.github.io/2019/06/05/check-credit.html">查查查-各类信用查询</a></li>
        
        <li><a href="/duansheli.github.io/2019/06/05/relax.html">休闲娱乐</a></li>
        
        <li><a href="/duansheli.github.io/2019/05/25/download-openjdk.html">各类openjdk下载地址</a></li>
        
        <li><a href="/duansheli.github.io/2019/05/18/dind-build-image-with-cache.html">DinD模式下通过容器构建镜像-方案</a></li>
        
        <li><a href="/duansheli.github.io/2019/05/17/thinking-autoboxing-implicit.html">自动装箱拆箱在scala中的表现</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="/tags/jvm">jvm</a></li>
                                
                            </ul>
                            
                        </div>
                    </article>
                    
    

    
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="/duansheli.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="/duansheli.github.io/2019/09/12/doh.html" title="浏览器启用dns-over-https(DoH)">浏览器启用dns-over-https(DoH)</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/09/09/docker-cp.html" title="docker的复制文件操作">docker的复制文件操作</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/09/03/hashids-usage.html" title="使用hashids创建短链服务">使用hashids创建短链服务</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/09/07/zero-width.html" title="给文章加水印-零宽字符">给文章加水印-零宽字符</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/08/16/hashids-usage.html" title="激活码的生成">激活码的生成</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/08/02/k8s-cluster-setup-02.html" title="mysql物理备份与还原示例">mysql物理备份与还原示例</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/02/10/jstack-demo.html" title="使用jstack分析线程-示例">使用jstack分析线程-示例</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/06/05/check-credit.html" title="查查查-各类信用查询">查查查-各类信用查询</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/06/05/relax.html" title="休闲娱乐">休闲娱乐</a>
    </li>
    
    <li>
        <a href="/duansheli.github.io/2019/05/25/download-openjdk.html" title="各类openjdk下载地址">各类openjdk下载地址</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li>
        <a href="/categories/Java%E6%B7%B1%E5%85%A5/">Java深入(8)</a>
    </li>
    
    <li>
        <a href="/categories/k8s%E9%9B%86%E7%BE%A4/">k8s集群(3)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="/tags/Java/">Java</a>
    
    <a href="/tags/classloader/">classloader</a>
    
    <a href="/tags/docker/">docker</a>
    
    <a href="/tags/drone/">drone</a>
    
    <a href="/tags/dubbo/">dubbo</a>
    
    <a href="/tags/elasticsearch/">elasticsearch</a>
    
    <a href="/tags/gc/">gc</a>
    
    <a href="/tags/hashids/">hashids</a>
    
    <a href="/tags/id/">id</a>
    
    <a href="/tags/java/">java</a>
    
    <a href="/tags/jdk/">jdk</a>
    
    <a href="/tags/jvm/">jvm</a>
    
    <a href="/tags/k8s/">k8s</a>
    
    <a href="/tags/life/">life</a>
    
    <a href="/tags/mysql/">mysql</a>
    
    <a href="/tags/proxy/">proxy</a>
    
    <a href="/tags/rocketmq/">rocketmq</a>
    
    <a href="/tags/route/">route</a>
    
    <a href="/tags/scala/">scala</a>
    
    <a href="/tags/session/">session</a>
    
    <a href="/tags/spring-boot/">spring-boot</a>
    
    <a href="/tags/spring-security/">spring-security</a>
    
    <a href="/tags/springboot/">springboot</a>
    
    <a href="/tags/zipkin/">zipkin</a>
    
    <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">分布式事务</a>
    
    <a href="/tags/%E7%99%BB%E5%BD%95/">登录</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="/duansheli.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="/duansheli.github.io">断舍离的博客 By 断舍离</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        
        (function () {
            $("pre code").parent().addClass("line-numbers")
        }());

        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script type="text/javascript" src="/duansheli.github.io/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/duansheli.github.io/js/totop.js?v=0.0.0" async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GTM-NPJC8J2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>
</html>
